<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¸¾æ•ˆè©¦ç®—ç³»çµ± v2.0</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.0/dist/reset.css">
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.0/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/antd@5.12.0/dist/antd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background-color: #f5f5f5; }
        .header { background: #001529; color: white; padding: 0 50px; height: 64px; line-height: 64px; font-size: 20px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .container { max-width: 1400px; margin: 24px auto; padding: 0 24px; }
        .ant-card { margin-bottom: 16px; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // âš ï¸ é‡è¦ï¼šéƒ¨ç½²å¾Œè«‹æ›´æ›ç‚ºæ‚¨çš„ Apps Script URL
        const API_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
        
        const { useState, useEffect } = React;
        const { Card, Table, Button, DatePicker, Space, Statistic, Row, Col, message, Tag, Form, Input, InputNumber, Tabs, Modal, Typography } = antd;
        const { Text } = Typography;

        // å°è£ Axios è«‹æ±‚ï¼Œè™•ç† GAS çš„ Redirect ç‰¹æ€§
        const api = {
            get: (params) => axios.get(API_URL, { params }),
            post: (action, data) => axios.post(`${API_URL}?action=${action}`, JSON.stringify(data))
        };

        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            return (
                <div>
                    <div className="header">ğŸ“Š ç¸¾æ•ˆçé‡‘ç®¡ç†ç³»çµ±</div>
                    <div className="container">
                        <Tabs activeKey={activeTab} onChange={setActiveTab} items={[
                            { key: 'dashboard', label: 'ğŸ“ˆ ç¸¾æ•ˆå„€è¡¨æ¿', children: <Dashboard /> },
                            { key: 'import', label: 'ğŸ“¤ è³‡æ–™åŒ¯å…¥', children: <DataImport /> },
                            { key: 'settings', label: 'âš™ï¸ ç³»çµ±è¨­å®š', children: <SystemSettings /> }
                        ]} />
                    </div>
                </div>
            );
        }

        // --- 1. ç¸¾æ•ˆå„€è¡¨æ¿çµ„ä»¶ ---
        function Dashboard() {
            const [loading, setLoading] = useState(false);
            const [data, setData] = useState([]);
            const [selectedDate, setSelectedDate] = useState(dayjs());
            
            const fetchData = async () => {
                setLoading(true);
                try {
                    const res = await api.get({
                        action: 'getPerformance',
                        year: selectedDate.year(),
                        month: selectedDate.month() + 1
                    });
                    if(res.data.success) setData(res.data.data);
                } catch(e) { message.error('è¼‰å…¥å¤±æ•—'); }
                finally { setLoading(false); }
            };

            useEffect(() => { fetchData(); }, [selectedDate]);

            const handleCalculate = async () => {
                setLoading(true);
                try {
                    const res = await api.post('calculatePerformance', {
                        year: selectedDate.year(),
                        month: selectedDate.month() + 1
                    });
                    if(res.data.success) {
                        message.success('è¨ˆç®—å®Œæˆï¼');
                        setData(res.data.results);
                    } else {
                        message.error(res.data.error || 'è¨ˆç®—å¤±æ•—');
                    }
                } catch(e) { message.error('è«‹æ±‚å‡ºéŒ¯'); }
                finally { setLoading(false); }
            };

            const columns = [
                { title: 'æ’å', dataIndex: 'rank_position', key: 'rank', width: 90, fixed: 'left', render: (r) => r === 1 ? <Tag color="gold">ğŸ† 1</Tag> : r === 2 ? <Tag color="silver">ğŸ¥ˆ 2</Tag> : <Tag>{r}</Tag> },
                { title: 'å§“å', dataIndex: 'employee_name', key: 'name', width: 100, fixed: 'left' },
                { title: 'ç•¶æœˆä»¶æ•¸', dataIndex: 'current_cases', key: 'cases', width: 90, sorter: (a,b) => a.current_cases - b.current_cases },
                { title: '3æœˆå¹³å‡', dataIndex: 'avg_3months', render: v => v?.toFixed(2) },
                { title: 'æˆé•·çå‹µ', dataIndex: 'growth_bonus', render: v => <Text type={v > 0 ? "success" : "secondary"}>{v?.toFixed(4)}</Text> },
                { title: 'è¶…é¡åˆ†é…', dataIndex: 'excess_bonus', render: v => v?.toFixed(4) },
                { title: 'æ’åçå‹µ', dataIndex: 'rank_bonus', render: v => <Text type={v > 0 ? "danger" : "secondary"}>{v?.toFixed(4)}</Text> },
                { title: 'ç¸½é»å€¼', dataIndex: 'total_points', render: v => <Text strong style={{color:'#1890ff'}}>{v?.toFixed(4)}</Text>, sorter: (a,b) => a.total_points - b.total_points }
            ];

            return (
                <Card>
                    <Space style={{marginBottom: 24}}>
                        <DatePicker picker="month" value={selectedDate} onChange={setSelectedDate} allowClear={false} format="YYYYå¹´MMæœˆ" />
                        <Button type="primary" onClick={handleCalculate} loading={loading}>ğŸ§® é‡æ–°è¨ˆç®—ç¸¾æ•ˆ</Button>
                        <Button onClick={fetchData}>ğŸ”„ æ•´ç†æ•´ç†</Button>
                    </Space>
                    
                    <Row gutter={16} style={{marginBottom: 24}}>
                        <Col span={8}><Card size="small"><Statistic title="ç•¶æœˆç¸½äººæ•¸" value={data.length} suffix="äºº" /></Card></Col>
                        <Col span={8}><Card size="small"><Statistic title="å¹³å‡é»å€¼" value={data.length ? (data.reduce((s, d) => s + d.total_points, 0) / data.length).toFixed(4) : 0} /></Card></Col>
                        <Col span={8}><Card size="small"><Statistic title="æœ€é«˜ä»¶æ•¸" value={data.length ? Math.max(...data.map(d => d.current_cases)) : 0} valueStyle={{color: '#3f51b5'}} /></Card></Col>
                    </Row>

                    <Table columns={columns} dataSource={data} loading={loading} rowKey="employee_id" scroll={{x: 1000}} pagination={{pageSize: 15}} />
                </Card>
            );
        }

        // --- 2. è³‡æ–™åŒ¯å…¥çµ„ä»¶ ---
        function DataImport() {
            const [form] = Form.useForm();
            const [loading, setLoading] = useState(false);

            const onFinish = async (values) => {
                setLoading(true);
                try {
                    // è§£ææ–‡å­—å€åŸŸè³‡æ–™ (æ ¼å¼: å“¡å·¥ID, å§“å, ä»¶æ•¸)
                    const lines = values.raw_data.split('\n').filter(l => l.trim());
                    const records = lines.map(line => {
                        const [id, name, count] = line.split(/[,\s\t]+/);
                        return { employee_id: id, employee_name: name, case_count: parseFloat(count) };
                    });

                    if(records.some(r => isNaN(r.case_count))) {
                        throw new Error('éƒ¨åˆ†è³‡æ–™ä»¶æ•¸æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥');
                    }

                    const res = await api.post('importData', {
                        year: values.month.year(),
                        month: values.month.month() + 1,
                        records: records
                    });

                    if(res.data.success) {
                        message.success(res.data.message);
                        form.setFieldValue('raw_data', '');
                    }
                } catch(e) { message.error(e.message || 'åŒ¯å…¥å¤±æ•—'); }
                finally { setLoading(false); }
            };

            return (
                <Card title="æ‰¹é‡åŒ¯å…¥ç•¶æœˆä»¶æ•¸">
                    <Form form={form} layout="vertical" onFinish={onFinish} initialValues={{month: dayjs()}}>
                        <Form.Item name="month" label="æ­¸å±¬æœˆä»½" rules={[{required: true}]}>
                            <DatePicker picker="month" format="YYYY-MM" />
                        </Form.Item>
                        <Form.Item name="raw_data" label="è³‡æ–™è²¼ä¸Šå€ (æ ¼å¼: å“¡å·¥ID å§“å ä»¶æ•¸)" extra="å¯å¾ Excel ç›´æ¥é¸å–ä¸‰æ¬„å¾Œè²¼ä¸Šï¼Œæ”¯æ´ç©ºæ ¼æˆ– Tab åˆ†éš”" rules={[{required: true}]}>
                            <Input.TextArea rows={10} placeholder="E001 å¼µå°æ˜ 12&#10;E002 æå¤§è¯ 8..." />
                        </Form.Item>
                        <Button type="primary" htmlType="submit" loading={loading} block size="large">ğŸš€ é–‹å§‹åŒ¯å…¥è³‡æ–™</Button>
                    </Form>
                </Card>
            );
        }

        // --- 3. ç³»çµ±è¨­å®šçµ„ä»¶ ---
        function SystemSettings() {
            const [form] = Form.useForm();
            const [loading, setLoading] = useState(false);

            const loadSettings = async () => {
                const res = await api.get({ action: 'getSettings' });
                if(res.data.success) {
                    const obj = {};
                    res.data.data.forEach(item => obj[item.setting_key] = parseFloat(item.setting_value));
                    form.setFieldsValue(obj);
                }
            };

            useEffect(() => { loadSettings(); }, []);

            const saveSettings = async (values) => {
                setLoading(true);
                try {
                    const res = await api.post('updateSettings', values);
                    if(res.data.success) message.success('è¨­å®šå·²æ›´æ–°');
                } catch(e) { message.error('å„²å­˜å¤±æ•—'); }
                finally { setLoading(false); }
            };

            return (
                <Card title="è¨ˆç®—åƒæ•¸è¨­å®š">
                    <Form form={form} layout="vertical" onFinish={saveSettings}>
                        <Row gutter={16}>
                            <Col span={12}>
                                <Form.Item name="total_points" label="ç•¶æœˆåˆ†é…ç¸½é»æ•¸"><InputNumber style={{width:'100%'}} /></Form.Item>
                            </Col>
                            <Col span={12}>
                                <Form.Item name="base_cases" label="åŸºç¤é–€æª» (ä½æ–¼æ­¤æ•¸ç„¡çå‹µ)"><InputNumber style={{width:'100%'}} /></Form.Item>
                            </Col>
                            <Col span={8}>
                                <Form.Item name="growth_bonus" label="æˆé•·çé‡‘é»å€¼"><InputNumber style={{width:'100%'}} /></Form.Item>
                            </Col>
                            <Col span={8}>
                                <Form.Item name="rank1_bonus" label="Top 1 é¡å¤–çå‹µ"><InputNumber style={{width:'100%'}} /></Form.Item>
                            </Col>
                            <Col span={8}>
                                <Form.Item name="
